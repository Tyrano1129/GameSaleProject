<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
</head>
<body>
<form action="/users/join" id="userJoinForm" method="post">
    <fieldset>
        <legend><span>회원가입</span></legend>
        <table>
            <tr>
                <th>이메일</th>
                <td><label for="username"></label><input id="username" name="username" placeholder="이메일을 입력하세요."
                                                         required="required" type="email"/>
                    <button id="emailDuplicatedBtn" type="button">중복확인</button>
                    <label for="codeInput"></label><input id="codeInput" placeholder="인증코드를 입력하세요." style="visibility: hidden"
                                                          type="text"/>
                    <button id="emailSendingBtn" onclick="sendCodeToEmail()" style="visibility: hidden" type="button">
                        인증코드전송
                    </button>
                </td>
            </tr>
            <tr>
                <th>비밀번호</th>
                <td><label for="password"></label><input id="password" maxlength="16" name="password"
                                                         placeholder="비밀번호를 입력하세요." required="required"
                                                         type="password"/></td>
                <td><span>비밀번호는 최대 16자까지 가능합니다.</span>
                </td>
            </tr>
            <tr>
                <th>비밀번호확인</th>
                <td><label for="pwConfirm"></label><input id="pwConfirm" maxlength="16" name="pwConfirm"
                                                          placeholder="비밀번호를 다시 입력하세요." required="required"
                                                          type="password"/></td>
                <td id="pwNotCorresponding" style="visibility: hidden;">비밀번호가 일치하지 않습니다.</td>
            </tr>
            <tr>
                <th>닉네임</th>
                <td>
                    <label for="userNickname"></label><input id="userNickname" maxlength="10"
                                                             name="userNickname" placeholder="닉네임을 입력하세요."
                                                             required="required" type="text"/>
                </td>
                <td><span>닉네임은 최대 10자까지 가능합니다.</span></td>
            </tr>
            <tr>
                <th>전화번호</th>
                <td><label for="userPhone"></label><input id="userPhone" maxlength="13" name="userPhone"
                                                          placeholder="전화번호를 입력하세요."
                                                          required="required"
                                                          type="tel"/></td>
            </tr>
            <tr>
                <th>이메일 수신 동의</th>
                <td><label>
                    <input type="checkbox">
                </label>정보/이벤트 메일 수신에 동의합니다.
                </td>
                <td><span>※ 주문 관련 정보, 주요 공지사항 및 이벤트 당첨 안내 등은 수신 동의 여부에 관계없이 자동 발송됩니다.</span></td>
            </tr>
        </table>
    </fieldset>
    <div>
        <button title="홈으로" type="reset">홈으로</button>
        <button title="가입하기" type="reset">홈으로</button>
    </div>
</form>
</body>
</html>
<script>
    let check = 0;
    let pwCheck = -1;
    let emailAuthentication = -1;
    const emailInput = document.getElementById("username")
    const pwInput = document.getElementById("password");
    const pwConfirmInput = document.getElementById("pwConfirm");
    const emailDuplicatedBtn = document.getElementById("emailDuplicatedBtn");
    const emailSendingBtn = document.getElementById("emailSendingBtn");
    const codeInput = document.getElementById("codeInput");

    // 입력값들의 유효성 체크
    function validCheck(form) {
        if (!form.username.value.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/)) {
            alert("이메일 형식이 다릅니다");
            form.username.value = "test@test.com";
            form.username.focus();
            return false;
        }
        if (!form.password.value.trim()) {
            alert("비밀번호를 입력해주세요");
            form.password.focus();
            return false;
        }
        if (!pwConfirmInput.value.trim()) {
            alert("비밀번호확인을 입력해주세요");
            pwConfirmInput.focus();
            return false;
        }
        if (!form.userNickname.value.trim()) {
            alert("닉네임을 입력해주세요");
            form.userNickname.focus();
            return false;
        }
        if (!form.userPhone.value.match(/010-\d{3,4}-\d{4}/)) {
            alert("전화번호 형식이 다릅니다");
            form.userPhone.value = "010-1234-1234";
            form.userPhone.focus();
            return false;
        }

        // submit 하기 전에 모든 조건들 체크
        if (check === 0) {
            alert('이메일 중복체크를 해주세요.');
            return false;
        } else if (check === -1) {
            alert('이메일 중복체크를 다시해주세요.');
            return false;
        }
        if (pwCheck !== 1) {
            pwConfirmInput.focus();
            alert(`비밀번호를 확인하세요.`)
            return false;
        }
        if (emailAuthentication !== 1) {
            alert(`이메일 주소로 보내드린 인증코드를 확인하세요.`);
            return false;
        }

        // ***********
        form.submit();
        // ***********
    }

    // 이메일 중복 체크하는 버튼 이벤트
    emailDuplicatedBtn.addEventListener("click", () => {
        let username = document.getElementById("username").value.trim();

        if (username.length === 0) {
            alert("이메일을 입력해주세요");
            document.getElementById("username").focus();
            document.getElementById("username").style.border = "";
            return;
        }

        fetch("/users/emailDuplicated", {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",},
            body: "username=" + username,
        })
            .then(response => response.text())
            .then(getResult)
            .catch(error => console.log("error= ", error));
    });

    function getResult(data) {
        if (data === "valid") {
            alert("사용 가능한 이메일입니다.");
            document.getElementById("password").focus();
            document.getElementById("username").style.border = "3px blue solid";
            emailDuplicatedBtn.style.visibility = "hidden";
            emailSendingBtn.style.visibility = "visible";
            codeInput.style.visibility = "visible";
            check = 1;
        } else if (data === "invalid") {
            alert("이미 사용중인 이메일입니다.");
            document.getElementById("username").value = "";
            document.getElementById("username").focus();
            document.getElementById("username").style.border = "3px red solid";
            check = -1;
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("userJoinForm");

        // 폼에서 Enter 키를 눌렀을 때 validCheck 함수 호출
        form.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                validCheck(form);
            }
        });
    });

    // 비밀번호와 비밀번호확인이 일치하는지 판단하는 함수
    pwConfirmInput.addEventListener("keyup", () => {
        let pw = pwInput.value.trim();
        let pwConfirm = pwConfirmInput.value.trim();
        let pwNotCorresponding = document.getElementById("pwNotCorresponding");
        if (pw !== pwConfirm) {
            pwNotCorresponding.style.visibility = "visible";
            pwCheck = -1;
        } else {
            pwNotCorresponding.style.visibility = "hidden"; // 일치할 경우 숨김 처리
            pwCheck = 1;
        }
    });

    // 이메일 인풋을 수정했을 때 중복체크를 초기화하는 함수
    emailInput.addEventListener("keyup", () => {
        check = -1;
        document.getElementById("username").style.border = "3px red solid";
    });

    // 이메일로 인증코드를 발송하는 함수
    let emailCode;
    function sendCodeToEmail() {
        let email = document.getElementById("username");
        console.log(email.value);
        if (!email.value.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/)) {
            alert(`이메일 형식이 다릅니다.`);
            return false;
        }

        fetch("/users/sendCodeToEmail", {
            method: 'POST',
            headers: {
                "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
            },
            body: "email=" + email.value
        })
            .then(response => response.text())
            .then(data => {
                emailCode = data;
                if (data) {
                    alert(`인증코드가 메일로 발송되었습니다.`);

                } else {
                    alert(`인증코드 발송에 실패했습니다.`)
                }
            }).catch(error => console.error('Error:', error));
    }
</script>
